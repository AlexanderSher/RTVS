# Remote R Service for Linux

Remote R Service for Linux is currently packaged as rtvs-daemon. The daemon is supported and tested on Ubuntu 16.04, 16.10 LTS desktop, server, and Windows Subsystem for Linux running Ubuntu.


## Setting up Remote R Service

### On physical Ubuntu machine
After starting up follow these steps:
1. Log on to the machine and download rtvs-daemon tarball:
```
wget -O rtvs-daemon.tar.gz https://aka.ms/r-remote-services-linux-binary-current
tar -xvzf rtvs-daemon.tar.gz
```
2. Run the install script:
```
sudo ./rtvs-install
```
3. Enable and start the service:
```
sudo systemctl enable rtvsd
```
4. [required for production] Configure SSL certificate: 
By default, `rtvs-daemon` uses the `ssl-cert-snakeoil.pem` and `ssl-cert-snakeoil.pem` generated by `ssl-cert` pacakge. During installation we combine them into `ssl-cert-snakeoil.pfx`. For production purposes use the SSL certificate provided by your admin. SSL certificate can be configured by providing a PFX file and optional import password, in: `/etc/rtvs/rtvsd.config.json`
5. [optional] Check service is running:
```
ps -A -f | grep rtvsd
```
If you don’t see a process running under the user name `rtvssvc`. Start it using the following command:
```
sudo systemctl start rtvsd
```

### On Ubuntu Server VM on Azure
You will need Putty for windows, or other SSH client.
1. Log into https://portal.azure.com
2. Go to Virtual Machines and click on Add. 
3. This should bring up available VM images. Search for `Ubuntu Server 16.04 LTS`
4. Select it and set the deployment model as `Resource manager` and hit create.
5. Choose a name for the VM, type in username and password (password is required, we don’t support SSH public key login). Make changes as needed to the VM configuration.
6. In the next tab choose a VM size. Verify the configuration and hit create. It will take a while to build the VM.
7. Once it is done, in the Networking tab for the VM add `5444` as an allowed inbound port. If you want to use a different port, you can configure that in config file for rtvs daemon which can be found here: `/etc/rtvs/rtvsd.config.json`.
8. [optional] Set a DNS name, you can also use the IP address.
9. Connect to the VM using SSH client, and download the rtvs daemon tarball.
```
wget -O rtvs-daemon.tar.gz https://aka.ms/r-remote-services-linux-binary-current
tar -xvzf rtvs-daemon.tar.gz
```
10. Run the install script:
```
sudo ./rtvs-install
```
11. Enable and start the service:
```
sudo systemctl enable rtvsd
```
12. [required for production] Configure SSL certificate: 
By default, `rtvs-daemon` uses the `ssl-cert-snakeoil.pem` and `ssl-cert-snakeoil.pem` generated by `ssl-cert` pacakge. During installation we combine them into `ssl-cert-snakeoil.pfx`. For production purposes use the SSL certificate provided by your admin. SSL certificate can be configured by providing a PFX file and optional import password, in: `/etc/rtvs/rtvsd.config.json`
13. [optional] Check service is running:
```
ps -A -f | grep rtvsd
```
If you don’t see a process running under the user name rtvssvc. Start it using the following command:
```
sudo systemctl start rtvsd
```

### On Ubuntu DSVM on Azure
You will need Putty for windows, or other SSH client.
1. Log into https://portal.azure.com
2. Go to Virtual Machines and click on Add. 
3. This should bring up available VM images. Search for `Linux Data Science`.
4. Select the linux DSVM iamge and set the deployment model as `Resource manager` and hit create.
5. Choose a name for the VM, type in username and password (password is required, we don’t support SSH public key login). Make changes as needed to the VM configuration.
6. In the next tab choose a VM size. Verify the configuration and hit create. It will take a while to build the VM.
7. Once it is done, in the Networking tab for the VM add `5444` as an allowed inbound port. If you want to use a different port, you can configure that in config file for rtvs daemon which can be found here: `/etc/rtvs/rtvsd.config.json`.
8. [optional] Set a DNS name, you can also use the IP address.
9. Connect to the VM using SSH client, and download the rtvs daemon tarball:
```
wget -O rtvs-daemon.tar.gz https://aka.ms/r-remote-services-linux-binary-current
tar -xvzf rtvs-daemon.tar.gz
```
10. Run the install script:
```
sudo ./rtvs-install
```
11. Enable and start the service:
```
sudo systemctl enable rtvsd
```
12. [required for production] Configure SSL certificate: 
By default, `rtvs-daemon` uses the `ssl-cert-snakeoil.pem` and `ssl-cert-snakeoil.pem` generated by `ssl-cert` pacakge. During installation we combine them into `ssl-cert-snakeoil.pfx`. For production purposes use the SSL certificate provided by your admin. SSL certificate can be configured by providing a PFX file and optional import password, in: `/etc/rtvs/rtvsd.config.json`
13. [optional] Check service is running:
```
ps -A -f | grep rtvsd
```
If you don’t see a process running under the user name rtvssvc. Start it using the following command:
```
sudo systemctl start rtvsd
```

### On Windows Subsystem for Linux (WSL)
1. Instructions to setup WSL. 
https://msdn.microsoft.com/en-us/commandline/wsl/install_guide
2. Start bash on Windows and download rtvs daemon tarball:
```
wget -O rtvs-daemon.tar.gz https://aka.ms/r-remote-services-linux-binary-current
tar -xvzf rtvs-daemon.tar.gz
```
3. Run the install script:
```
sudo ./rtvs-install
```
4. [required for production] Configure SSL certificate: 
By default, `rtvs-daemon` uses the `ssl-cert-snakeoil.pem` and `ssl-cert-snakeoil.pem` generated by `ssl-cert` pacakge. During installation we combine them into `ssl-cert-snakeoil.pfx`. For production purposes use the SSL certificate provided by your admin. SSL certificate can be configured by providing a PFX file and optional import password, in: `/etc/rtvs/rtvsd.config.json`
5. Start rtvs daemon, execute the following command:
```
rtvsd
```
Note: WSL currently does not support systemd/systemctl interfaces.


### In a Docker container running locally (clean build)
1. Dockerfile contents:
```
FROM ubuntu:16.04

ARG DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
 && apt-get install -y software-properties-common python-software-properties \
 && apt-get install -y apt-transport-https \
 && rm -rf /var/lib/apt/lists/*

RUN sh -c 'echo "deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ xenial main" > /etc/apt/sources.list.d/dotnetdev.list' \
 && apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 417A0893 \
 && sh -c 'echo "deb https://cran.revolutionanalytics.com/bin/linux/ubuntu xenial/" > /etc/apt/sources.list.d/cran-r.list' \
 && apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9 \
 && rm -rf /var/lib/apt/lists/* \
 && apt-get clean

RUN apt-get update --fix-missing && apt-get update \
 && apt-get install -y dotnet-dev-1.0.4 libexplain51 libzip4 libc6 git lshw ssl-cert wget \
 && rm -rf /var/lib/apt/lists/*

# install R
RUN apt-get update && apt-get install -y r-base-dev
RUN apt upgrade -y

# install rtvs-daemon
RUN wget -O rtvs-daemon.tar.gz https://aka.ms/r-remote-services-linux-binary-current && tar -xvzf rtvs-daemon.tar.gz && ./rtvs-install -s

RUN useradd --create-home ruser1
RUN echo "ruser1:foobar" | chpasswd

EXPOSE 5444
```
This will install Remote R service daemon and the latest version of R. Note the **username** and **password**, you will need this to connect to the container.
1. Build and run the above docker file:
```
docker build -t myrimage .
docker run -p 5444:5444 myrimage rtvsd
```
2. You can connect to this container from RTVS. Use `https://localhost:5444` as the path, username `ruser1`, and password `foobar`. If the docker container is running on the remote machine then use `https://remote-host-name:5444`. The port can be changed by updating `/etc/rtvs/rtvsd.config.json`


### In a container running on Azure Container Instances
Use instructions from running in docker container to create a image.
1. Push the container to docker hub or Azure Container Repository.
3. Start the Azure CLI and logon to azure using `az login` command.
4. Use `az container create` command to create the container. Use `--command-line "rtvsd"`, if you have not setup the container to run `rtvsd` as a `systemd` service. In the command below the image is expected to be on docker hub. You can also use Azure ACR for this, by adding ACR login arguments to the command line.
```
az container create --image myimage:latest --name myaz-container --resource-group myaz-container-res --ip-address public --port 5444 --cpu 2 --memory 4 --command-line "rtvsd"
```
5.  Use `az container list` command to check the status. Look for `provisioningState`: `Succeeded`.
6.  If the provisioning succeeded, you can now connect to the container. Look for the public IP address, in the `ipAddress` field. Use that to connect to the container from RTVS. Rememeber to use username and password as it was in the docker file.


## Connecting from RTVS

1. Open workspaces window from R Tools > Windows > Workspaces.
2. Click on Add Connection.
3. Give the connection a name and add the path. Example for WSL `https://localhost:5444`, Example for acure container `https://public-ip:5444`. Hit Save.
4. Click on connect icon or double click on the connection item.
5. Username should be entered in the following format: `<<unix>>\ruser1`. Do not forget the `<<unix>>\` prefix for all connections to Linux remotes.
6. If you are using self-signed certificate you may see a warning. Follow the instrcutions in the message box.
7. You should now be connected to the Linux rtvs daemon.
